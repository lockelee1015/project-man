#!/bin/bash

# Project Man wrapper script
# This script provides directory changing functionality for p go/add commands

# Find the binary in the same directory as this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BINARY_PATH="$SCRIPT_DIR/p-bin"

# Check if binary exists
if [ ! -f "$BINARY_PATH" ]; then
    echo "‚ùå Error: Project Man binary not found at $BINARY_PATH"
    exit 1
fi

# Get the first argument (command)
cmd="$1"

# Commands that might change directory
if [ "$cmd" = "go" ] || [ "$cmd" = "add" ]; then
    # Execute command and capture output
    output=$("$BINARY_PATH" "$@" --output-cd 2>&1)
    exit_code=$?
    
    # Check if command was successful
    if [ $exit_code -eq 0 ]; then
        # Look for CD_TARGET in output
        cd_target=$(echo "$output" | grep "^CD_TARGET:" | cut -d: -f2-)
        
        if [ -n "$cd_target" ]; then
            # Change to the target directory
            cd "$cd_target" || {
                echo "‚ùå Failed to change directory to: $cd_target"
                exit 1
            }
            echo "üìÅ Changed to: $(pwd)"
        fi
        
        # Show other output (excluding CD_TARGET line)
        echo "$output" | grep -v "^CD_TARGET:"
    else
        # Show error output
        echo "$output"
        exit $exit_code
    fi
else
    # For other commands, just pass through
    "$BINARY_PATH" "$@"
fi